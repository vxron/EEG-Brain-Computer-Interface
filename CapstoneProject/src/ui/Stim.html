<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>EEG BCI Page-Turner – Local UI</title>
    <link rel="stylesheet" href="Stim.css?v=20251122-10" />
  </head>
  <body>
    <div class="app-shell">
      <!-- Left: status + config -->
      <aside class="sidebar">
        <header class="app-header">
          <h2>The Brain-Controlled Page-Turner</h2>
          <p class="subtitle">Using EEG signals to turn the pages of a book</p>
        </header>

        <section class="status-card">
          <div id="connection-status" class="status-pill">
            <span class="dot"></span>
            <span id="connection-label">Disconnected</span>
          </div>
          <div class="status-row">
            <span class="label">Monitor refresh</span>
            <span id="refresh-label" class="value">Measuring…</span>
          </div>
          <div class="status-row">
            <span class="label">Current State</span>
            <span id="status-ui-state" class="value">—</span>
          </div>
          <div class="status-row">
            <span class="label">Active User</span>
            <span id="status-active-subject" class="value">—</span>
          </div>
          <div class="status-row">
            <span class="label">Model</span>
            <span id="status-model" class="value">—</span>
          </div>
        </section>

        <section class="controls-card">
          <h3>Session Controls</h3>
          <div class="button-row">
            <button id="btn-start-calib" class="btn ghost">Calibration</button>
            <button id="btn-start-run" class="btn primary">Run Mode</button>
          </div>
          <div class="button-row" style="margin-top: 10px">
            <button id="btn-start-hw" class="btn primary">
              Hardware Setup
            </button>
            <button id="btn-open-settings" class="btn ghost">Settings</button>
          </div>
        </section>
      </aside>

      <!-- Right: main view area -->
      <main class="main-panel">
        <!-- Full-screen exit button (shown in calib/run) -->
        <button id="btn-exit" class="btn exit-btn hidden" type="button">
          Exit Session
        </button>
        <button id="btn-pause" class="btn ghost hidden" type="button">
          Pause
        </button>
        <!-- main VIEW STACK (fills most of the right side) -->
        <div class="view-stack">
          <!-- HOME VIEW -->
          <section id="view-home" class="view">
            <h2>Welcome,</h2>
            <p class="view-lead">
              Choose how you want to use the EEG page-turner today.
            </p>

            <div class="home-actions">
              <div class="home-card">
                <h2>1: Calibration</h2>
                <p>
                  For new users or when you adjust the headset. Runs
                  single-frequency blocks to train a personalized SSVEP
                  classifier.
                </p>
                <span class="home-tag">Recommended first time</span>
              </div>

              <div class="home-card">
                <h2>2: Run Mode</h2>
                <p>
                  Uses the latest trained model. Look at the left or right arrow
                  to turn pages hands-free.
                </p>
                <span class="home-tag">Requires trained model</span>
              </div>

              <div class="home-card">
                <h2>3: Hardware Setup</h2>
                <p>
                  Opens the live EEG view so you can verify electrode contact
                  and channel quality before starting a session.
                </p>
                <span class="home-tag">Live signal viewer</span>
              </div>
            </div>

            <p class="home-tip">
              Tip: run <strong>Hardware Setup</strong> first, then do
              <strong>Calibration</strong>, and finally start
              <strong>Run Mode</strong>
              once you’re happy with the signals.
            </p>
          </section>

          <!-- INSTRUCTIONS VIEW -->
          <section id="view-instructions" class="view hidden">
            <h2>Instructions</h2>
            <p id="instructions-text" class="view-lead">
              Rest for a few seconds, then focus on the indicated flicker block.
            </p>
            <div class="inline-stats">
              <div>
                <span class="label">Block</span>
                <span id="instr-block-id" class="value">—</span>
              </div>
              <div>
                <span class="label">Upcoming frequency</span>
                <span id="instr-freq-hz" class="value">— Hz</span>
              </div>
            </div>
          </section>

          <!-- ACTIVE CALIBRATION VIEW -->
          <section id="view-active-calib" class="view hidden">
            <h2>Calibration Block</h2>
            <p class="view-lead">
              Focus your gaze on the flickering square to record your SSVEP
              responses.
            </p>
            <div class="flicker-stage">
              <div class="target calib-target">
                <div id="calib-block" class="flicker-block calib-flicker"></div>
              </div>
            </div>
          </section>

          <!-- ACTIVE RUN VIEW -->
          <section id="view-active-run" class="view hidden">
            <h2>Page Turning</h2>
            <p class="view-lead">
              Look at the left or right arrow to turn pages backward or forward.
            </p>
            <div class="targets-stage dual">
              <!-- LEFT -->
              <div class="target-col">
                <div class="target-action-label">Turn page back</div>

                <div class="target">
                  <div class="flicker-block arrow-left" id="run-left">
                    <span class="arrow">←</span>
                  </div>
                </div>
              </div>

              <!-- RIGHT -->
              <div class="target-col">
                <div class="target-action-label">Turn page forward</div>

                <div class="target">
                  <div class="flicker-block arrow-right" id="run-right">
                    <span class="arrow">→</span>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- RUN OPTIONS VIEW (START DEFAULT OR SEE PREV SESSIONS) -->
          <section id="view-run-options" class="view hidden">
            <h2>Run Options</h2>
            <p class="view-lead">
              Welcome back, <span id="run-welcome-name">friend</span>. Choose
              how you want to start the session.
            </p>

            <div class="inline-stats">
              <div>
                <span class="label">Last trained subject</span>
                <span id="run-last-subject" class="value">—</span>
              </div>
              <div>
                <span class="label">Model status</span>
                <span id="run-model-status" class="value">—</span>
              </div>
            </div>

            <div class="button-row" style="margin-top: 14px">
              <button id="btn-run-start-default" class="btn primary">
                Start with latest model
              </button>
              <button id="btn-run-saved-sessions" class="btn ghost">
                Choose saved session…
              </button>
            </div>
          </section>

          <!-- CALIB OPTIONS VIEW -->
          <section id="view-calib-options" class="view hidden">
            <div class="card">
              <h2>Calibration Setup</h2>
              <p class="muted">
                New user? Start here. Please enter your name and confirm you can
                safely view flickering stimuli. If you are photosensitive, but
                tolerant to higher frequencies, the app can still be run at
                higher frequencies, but might not work as well.
              </p>

              <label class="field">
                <span>Name</span>
                <input
                  id="calib-name"
                  type="text"
                  placeholder="e.g., khalil"
                  autocomplete="off"
                />
              </label>

              <label class="field">
                <span>Epilepsy / Photosensitivity risk</span>
                <!-- values MUST match backend enum EpilepsyRisk_E -->
                <select id="calib-epilepsy">
                  <option value="4">Select…</option>
                  <option value="0">No known risk</option>
                  <option value="1">
                    At risk, but tolerant to high frequency
                  </option>
                  <option value="2">At risk (do not proceed)</option>
                  <option value="3">Unsure</option>
                </select>
              </label>

              <div class="row">
                <button id="btn-calib-back" class="btn secondary">Back</button>
                <button id="btn-calib-submit" class="btn primary">
                  Start Calibration
                </button>
              </div>
            </div>
          </section>

          <!-- NoSSVEP / Neutral VIEW: mimic runtime -->
          <section
            id="view-neutral"
            class="view hidden view-neutral neutral"
            aria-label="Neutral / Rest state"
          >
            <header class="viewHeader">
              <h2 class="viewTitle">Neutral (Rest)</h2>
              <p class="viewSubtitle">Relax. Do anything non-flickering.</p>
            </header>

            <!-- Stage: 3-item flex row (Left target • Center instructions • Right target) -->
            <div id="neutral-stage" class="targets-stage triple">
              <div
                id="no-left-arrow"
                class="target runtime-target flicker-block arrow-left"
                role="img"
                aria-label="Left stimulus (do not focus)"
              >
                <span id="no-left-freq" class="freq-badge">— Hz</span>
              </div>

              <!-- CENTER instructions -->
              <div
                id="neutral-instructions"
                class="neutral-instructions"
                aria-label="Neutral instructions"
              >
                <div
                  class="neutral-alert"
                  role="note"
                  aria-label="Critical instruction"
                >
                  <div class="neutral-alert-title">
                    DO NOT FOCUS ON THE FLICKERS
                  </div>
                  <div class="neutral-alert-sub">
                    Treat them like background. Look anywhere else.
                  </div>
                </div>

                <ul id="neutral-instruction-list" class="instructionList">
                  <li>
                    Look anywhere you want: screen or not screen (but nothing
                    flickering).
                  </li>
                  <li>Look around the room.</li>
                  <li>Close your eyes.</li>
                </ul>

                <p id="neutral-note" class="instructionNote">
                  Tip: Read a book!
                </p>
              </div>

              <div
                id="no-right-arrow"
                class="target runtime-target flicker-block arrow-right"
                role="img"
                aria-label="Right stimulus (do not focus)"
              >
                <span id="no-right-freq" class="freq-badge">— Hz</span>
              </div>
            </div>
          </section>

          <!-- SETTINGS VIEW -->
          <section id="view-settings" class="view hidden">
            <h2>Settings</h2>
            <p class="view-lead">
              Configure your BCI training parameters and stimulus frequencies
            </p>

            <div class="settings-grid">
              <!-- Left Column: Training Settings -->
              <div class="settings-col">
                <!-- Card 1: Training Configuration -->
                <div class="settings-card">
                  <h3>Training Configuration</h3>

                  <div class="setting-group">
                    <label for="set-train-arch">
                      Model Architecture
                      <span class="help-text"
                        >AI model structure for classification</span
                      >
                    </label>
                    <select id="set-train-arch" class="setting-select">
                      <option value="1">SVM (Support Vector Machine)</option>
                      <option value="0">
                        CNN (Convolutional Neural Network)
                      </option>
                    </select>
                  </div>

                  <div class="setting-group">
                    <label for="set-calib-data">
                      Calibration Data
                      <span class="help-text"
                        >Which data to use for training</span
                      >
                    </label>
                    <select id="set-calib-data" class="setting-select">
                      <option value="0">Most Recent Session Only</option>
                      <option value="1">All Sessions (Up to 3)</option>
                    </select>
                  </div>

                  <div class="setting-group">
                    <label class="settings-label" for="set-waveform">
                      Waveform
                      <span class="help-text"
                        >How the oscillation is shaped</span
                      >
                    </label>
                    <select id="set-waveform" class="setting-select">
                      <option value="square">Square</option>
                      <option value="sine">Sinusoid</option>
                    </select>
                  </div>

                  <div class="setting-group">
                    <label class="settings-label" for="set-modulation">
                      Modulation
                      <span class="help-text">What property is modulated</span>
                    </label>
                    <select id="set-modulation" class="setting-select">
                      <option value="flicker">Flicker (Brightness)</option>
                      <option value="grow">Grow / Shrink (Scale)</option>
                    </select>
                  </div>
                </div>

                <!-- Card 2: Training Timing (SEPARATE CARD) -->
                <div class="settings-card timing-card">
                  <div class="timing-head">
                    <h3>Training Timing</h3>
                    <p class="muted">
                      Block durations and cycle count for calibration.
                    </p>
                  </div>

                  <!-- Active -->
                  <div class="timing-row">
                    <div class="timing-label">
                      <div class="timing-title">Active duration</div>
                      <div class="timing-sub">
                        Time focusing on each stimulus.
                      </div>
                    </div>
                    <div class="timing-control">
                      <input
                        id="set-duration-active"
                        type="range"
                        min="5"
                        max="20"
                        step="1"
                        value="11"
                      />
                      <div class="timing-pill">
                        <span id="set-duration-active-label">11</span
                        ><span class="unit">s</span>
                      </div>
                    </div>
                  </div>

                  <!-- None -->
                  <div class="timing-row">
                    <div class="timing-label">
                      <div class="timing-title">
                        Neutral / No-SSVEP duration
                      </div>
                      <div class="timing-sub">
                        Time recording “not attending” to stimuli.
                      </div>
                    </div>
                    <div class="timing-control">
                      <input
                        id="set-duration-none"
                        type="range"
                        min="5"
                        max="20"
                        step="1"
                        value="10"
                      />
                      <div class="timing-pill">
                        <span id="set-duration-none-label">10</span
                        ><span class="unit">s</span>
                      </div>
                    </div>
                  </div>

                  <!-- Rest -->
                  <div class="timing-row">
                    <div class="timing-label">
                      <div class="timing-title">Rest duration</div>
                      <div class="timing-sub">
                        Full rest block (no stimulus).
                      </div>
                    </div>
                    <div class="timing-control">
                      <input
                        id="set-duration-rest"
                        type="range"
                        min="5"
                        max="20"
                        step="1"
                        value="8"
                      />
                      <div class="timing-pill">
                        <span id="set-duration-rest-label">8</span
                        ><span class="unit">s</span>
                      </div>
                    </div>
                  </div>

                  <!-- Repeats -->
                  <div class="timing-row">
                    <div class="timing-label">
                      <div class="timing-title">Cycle repeats</div>
                      <div class="timing-sub">
                        How many times to repeat the cycle.
                      </div>
                    </div>
                    <div class="timing-control">
                      <input
                        id="set-cycle-repeats"
                        type="range"
                        min="1"
                        max="10"
                        step="1"
                        value="3"
                      />
                      <div class="timing-pill">
                        <span id="set-cycle-repeats-label">3</span
                        ><span class="unit">x</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Right Column: Frequency Selection -->
              <div class="settings-card">
                <h3>Calibration Frequencies</h3>

                <p class="freq-instruction">
                  Select <strong>up to 6 frequencies</strong> for calibration.
                  Choose well-separated values for best accuracy.
                </p>

                <div class="freq-grid">
                  <!-- 8-12 Hz: Low/Alpha band -->
                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="0"
                      data-hz="8"
                    />
                    <span class="freq-label">
                      <span class="freq-hz">8 Hz</span>
                      <span class="freq-tag band-low">Low</span>
                    </span>
                  </label>

                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="1"
                      data-hz="9"
                    />
                    <span class="freq-label">
                      <span class="freq-hz">9 Hz</span>
                      <span class="freq-tag band-low">Low</span>
                    </span>
                  </label>

                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="2"
                      data-hz="10"
                      checked
                    />
                    <span class="freq-label">
                      <span class="freq-hz">10 Hz</span>
                      <span class="freq-tag recommended">Peak</span>
                    </span>
                  </label>

                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="3"
                      data-hz="11"
                    />
                    <span class="freq-label">
                      <span class="freq-hz">11 Hz</span>
                      <span class="freq-tag band-low">Low</span>
                    </span>
                  </label>

                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="4"
                      data-hz="12"
                      checked
                    />
                    <span class="freq-label">
                      <span class="freq-hz">12 Hz</span>
                      <span class="freq-tag band-med">Med</span>
                    </span>
                  </label>

                  <!-- 13-18 Hz: Medium band -->
                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="5"
                      data-hz="13"
                    />
                    <span class="freq-label">
                      <span class="freq-hz">13 Hz</span>
                      <span class="freq-tag band-med">Med</span>
                    </span>
                  </label>

                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="6"
                      data-hz="14"
                    />
                    <span class="freq-label">
                      <span class="freq-hz">14 Hz</span>
                      <span class="freq-tag band-med">Med</span>
                    </span>
                  </label>

                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="7"
                      data-hz="15"
                    />
                    <span class="freq-label">
                      <span class="freq-hz">15 Hz</span>
                      <span class="freq-tag recommended">Peak</span>
                    </span>
                  </label>

                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="8"
                      data-hz="16"
                    />
                    <span class="freq-label">
                      <span class="freq-hz">16 Hz</span>
                      <span class="freq-tag band-med">Med</span>
                    </span>
                  </label>

                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="9"
                      data-hz="17"
                    />
                    <span class="freq-label">
                      <span class="freq-hz">17 Hz</span>
                      <span class="freq-tag band-med">Med</span>
                    </span>
                  </label>

                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="10"
                      data-hz="18"
                    />
                    <span class="freq-label">
                      <span class="freq-hz">18 Hz</span>
                      <span class="freq-tag band-med">Med</span>
                    </span>
                  </label>

                  <!-- 20-35 Hz: High band -->
                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="11"
                      data-hz="20"
                    />
                    <span class="freq-label">
                      <span class="freq-hz">20 Hz</span>
                      <span class="freq-tag band-high">High</span>
                    </span>
                  </label>

                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="12"
                      data-hz="25"
                    />
                    <span class="freq-label">
                      <span class="freq-hz">25 Hz</span>
                      <span class="freq-tag band-high">High</span>
                    </span>
                  </label>

                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="13"
                      data-hz="30"
                    />
                    <span class="freq-label">
                      <span class="freq-hz">30 Hz</span>
                      <span class="freq-tag band-high">High</span>
                    </span>
                  </label>

                  <label class="freq-checkbox">
                    <input
                      type="checkbox"
                      name="freq-select"
                      value="14"
                      data-hz="35"
                    />
                    <span class="freq-label">
                      <span class="freq-hz">35 Hz</span>
                      <span class="freq-tag band-high">High</span>
                    </span>
                  </label>
                </div>

                <div id="freq-warning" class="freq-warning">2 selected</div>
              </div>
            </div>

            <!-- Compact Research Tips -->
            <div class="settings-card tips-card">
              <h3>Frequency Selection Tips</h3>
              <div class="tips-grid">
                <div class="tip">
                  <strong>Best Response:</strong> 10 Hz (low band) and 15-18 Hz
                  (medium band)
                </div>
                <div class="tip">
                  <strong>Avoid Harmonics:</strong> Don't pair 7 Hz with 14 Hz,
                  or 10 Hz with 20 Hz
                </div>
                <div class="tip">
                  <strong>Comfortable:</strong> Higher frequencies (20+ Hz) are
                  less visible and more comfortable
                </div>
                <div class="tip">
                  <strong>Good Sets:</strong> Try 9/14/22 Hz or 10/15/20 Hz for
                  balanced performance
                </div>
              </div>
            </div>

            <div class="settings-footer">
              <div id="settings-status" class="settings-status"></div>
              <div class="button-row">
                <button id="btn-settings-back" class="btn secondary">
                  Back
                </button>
                <button id="btn-settings-save" class="btn primary">
                  Save Settings
                </button>
              </div>
            </div>
          </section>

          <!-- SESSIONS PAGE VIEW -->
          <section id="view-saved-sessions" class="view hidden">
            <h2>Saved Sessions</h2>
            <p class="view-lead">
              Select a previous session to load its trained model, or start a
              new one.
            </p>

            <!-- Placeholder list; filled from GET /state as calib sessions are run -->
            <!-- will be made clickable in css -->
            <div id="sessions-empty" class="label" style="margin-bottom: 8px">
              No saved sessions yet.
            </div>
            <ul id="sessions-list" class="sessions-list">
              <!-- <li> items injected by JS -->
            </ul>

            <div class="button-row" style="margin-top: 14px">
              <button id="btn-sessions-new" class="btn primary">
                Start new session
              </button>
              <button id="btn-sessions-back" class="btn ghost">
                Back to run options
              </button>
            </div>
          </section>
        </div>

        <!-- HARDWARE CHECKS VIEW -->
        <section id="view-hardware-checks" class="view hidden">
          <h2>Hardware Setup & Signal Quality Checker</h2>
          <br />
          <p class="view-lead">
            Verify headset placement and electrode contact by inspecting
            per-channel signal quality indicators and live EEG trace.
          </p>
          <br />
          <!-- Quality indicators row -->
          <!-- Health header -->
          <div class="hw-health">
            <div class="hw-health-left">
              <div id="hw-health-badge" class="hw-health-badge good">
                <span class="dot"></span>
                <div class="txt">
                  <div class="title">Signal Health</div>
                  <div id="hw-health-label" class="sub">—</div>
                </div>
              </div>

              <div class="hw-health-meta">
                <div class="meta-item">
                  <div class="k">Rolling Bad Windows</div>
                  <div id="hw-roll-bad" class="v">—%</div>
                </div>
                <div class="meta-item">
                  <div class="k">Overall Bad Windows</div>
                  <div id="hw-overall-bad" class="v">—%</div>
                </div>
                <div class="meta-item">
                  <div class="k">Number of Windows in Rolling</div>
                  <div id="hw-roll-n" class="v">—</div>
                </div>
              </div>
            </div>

            <div class="hw-health-right">
              <div class="hw-health-hint">
                Green = stable signal. Yellow = borderline. Red = too many
                artifact windows.
              </div>
            </div>
          </div>

          <!-- Scrollable container with stacked channel plots -->
          <div id="hw-plots-container" class="hw-plots-container">
            <!-- channel canvases will be injected by JS -->
          </div>
        </section>

        <!-- MODAL OVERLAY (popups) -->
        <div id="modal-backdrop" class="modal-backdrop hidden">
          <div class="modal">
            <h3 id="modal-title">Notice</h3>
            <p id="modal-body">
              You must complete at least one calibration session before starting
              run mode.
            </p>
            <div class="button-row" style="margin-top: 10px">
              <button id="modal-ok" class="btn primary">OK</button>
              <button id="modal-cancel" class="btn ghost hidden">Cancel</button>
            </div>
          </div>
        </div>

        <!-- PENDING TRAINING OVERLAY -->
        <div
          id="training-overlay"
          class="busy-backdrop hidden"
          aria-hidden="true"
        >
          <button
            id="btn-cancel-training"
            class="busy-cancel-btn"
            type="button"
          >
            Cancel Training (Return Home)
          </button>
          <div
            class="busy-card"
            role="dialog"
            aria-modal="true"
            aria-label="Training"
          >
            <div class="busy-head">
              <div class="busy-title">Training model...</div>
              <div class="busy-sub">
                This may take several minutes. Please keep the app open.
              </div>
            </div>

            <div class="busy-progress" aria-label="Training progress">
              <div class="busy-bar"></div>
            </div>

            <div class="busy-foot">
              <span class="busy-pill">
                <span class="busy-dot"></span>
                Running Python training job on calibration data.
              </span>
            </div>
          </div>
        </div>

        <!-- PAUSE OVERLAY -->
        <div
          id="pause-overlay"
          class="pause-backdrop hidden"
          aria-hidden="true"
        >
          <button id="btn-pause-exit" class="pause-exit-btn" type="button">
            Exit Session
          </button>

          <div
            class="pause-card"
            role="dialog"
            aria-modal="true"
            aria-label="Paused"
          >
            <div class="pause-title">Paused</div>
            <div class="pause-sub">
              Session is paused. Resume when you’re ready.
            </div>

            <div class="pause-actions">
              <button
                id="btn-resume"
                class="btn pause-resume-btn"
                type="button"
              >
                Resume
              </button>
            </div>
          </div>
        </div>

        <!-- LOG PANEL (small strip at the bottom) -->
        <section class="log-panel">
          <h3>Event Log</h3>
          <div id="log" class="log-body"></div>
        </section>
      </main>
    </div>

    <!-- Overlay div for clean transitions -->
    <div id="view-transition" class="view-transition hidden"></div>

    <!-- Local Chart.js (open src lib)) -->
    <script src="lib/chart.umd.min.js"></script>
    <!-- Main script -->
    <script src="Stim.js?v=20251119-19"></script>
  </body>
</html>
